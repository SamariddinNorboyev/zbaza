{% extends 'products/base.html' %}
{% block title %}
<title>List</title>
<style>


.table-nav{
    width:100%;
    display: flex;
    justify-content: center;
}
.table{
    width: 95%!important;
}
h1{
    width: 100%;
    display: flex;
    justify-content: center;
}

.blank{
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: #a6a6a6;
    opacity: 70%;
    z-index: 3;
    display: none;
}

.approve{
    width: 40%;
    height: 30vh;
    background-color: white;
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 5;
    padding: 2vh;
    display: none;
}
.approve input{
    margin: 1vh;
}
.approve-block input{
    display: none;
}

@media (max-width: 768px) {
    .table thead {
        display: none;
    }

    .table, .table tbody, .table tr, .table td {
        display: block;
        width: 100%;
    }

    .table tr {
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        padding: 1rem;
        border-radius: 8px;
        background-color: #f9f9f9;
    }

    .table td {
        text-align: left;
        padding: 0.5rem 0;
        border: none;
    }

    .table td::before {
        content: attr(data-label);
        font-weight: bold;
        display: inline-block;
        width: 120px;
    }

    select, input, button {
        width: 100%;
        margin-top: 0.5rem;
    }
}

</style>
{% endblock %}
{% block body %}

{% if messages %}
    <div class="mt-3">
        {% for message in messages %}
            {% if message.tags == 'error' %}
                {% with 'danger' as alert_class %}
                    <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endwith %}
            {% else %}
                {% with message.tags as alert_class %}
                    <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endwith %}
            {% endif %}
        {% endfor %}
    </div>
{% endif %}

{% if request.user.is_superuser or request.user.is_master %}
<br><br>

<h1 class="text-center my-4">Barcha Productlar</h1>

<div class="table-responsive px-3">
    <table class="table table-bordered table-hover align-middle text-center">
        <thead class="table-dark">
            <tr>
                <th scope="col">N%</th>
                <th scope="col">Ism</th>
                <th scope="col">Kodi</th>
                <th scope="col">Soni</th>
                <th scope="col">Amal</th>
            </tr>
        </thead>
        <tbody>
            {% for product in page_obj %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ product.name }}</td>
                <td>{{ product.code }}</td>
                <td>{{ product.amount }}</td>
                <td>
                    <a class="btn btn-sm btn-outline-warning me-1" href="{% url 'products:edit' product.id %}">
                        ‚úèÔ∏è Tahrirlash
                    </a>
                    <a href="{% url 'products:delete' product.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Ishonchingiz komilmi?');">
                        üóëÔ∏è O‚Äòchirish
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">

            {# Previous arrow #}
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">&lt;</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&lt;</span></li>
            {% endif %}

            {# Page numbers with ellipsis #}
            {% for num in page_obj.paginator.page_range %}
                {% if num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                    {% if num == page_obj.number %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% elif num == 2 and page_obj.number > 5 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% elif num == page_obj.paginator.num_pages|add:'-1' and page_obj.number < page_obj.paginator.num_pages|add:'-4' %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            {# Next arrow #}
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">&gt;</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&gt;</span></li>
            {% endif %}

        </ul>
    </nav>

</div>
{% endif %}



    <br>
    <h1>
        Kerakli maxsulotni kiriting
    </h1>
    <div class="table-nav">
        <table class="table">
            <thead>
            <tr>
                <th scope="col"><label for="nameSelect">Ismini tanlang</label></th>
                <th scope="col"><label for="codeSelect">Kodni tanlang</label></th>
                <th scope="col">Soni</th>
                <th scope="col">Amal</th>
            </tr>
            </thead>
            <tbody>
            <tr scope="row">
                <td data-label="Ismini tanlang">
                    <input type="text" name="name" placeholder="Nomi" id="nameSelect">
                </td>
                <td data-label="Kodni tanlang">
                    <input type="text" name="code" placeholder="Kodi" id="codeSelect">
                </td>
                <td data-label="Soni">
                    <input type="number" id="product-amount" placeholder="Soni" name="amount">
                </td>
                <td data-label="Amal">
                    <button class="btn btn-primary" onclick="open_approve()">Yaratish</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="approve">
        <form action="" method="POST" id="approve_form">
            {% csrf_token %}
            <h1>Mahsulotni tekshiring!</h1>
            <br>
            <div class="approve-block">
                Ism:
                <input type="text" id="sel-name" name="name">
                <b id="sel-name-b"></b>
            </div>
            <div class="approve-block">
                Kodi:
                <input type="text" id="sel-code" name="code">
                <b id="sel-code-b"></b>
            </div>
            <div class="approve-block">
                Soni:
                <input type="text" id="sel-amount" name="amount">
                <b id="sel-amount-b"></b>
            </div>
            <br>

            <input type="button" class="btn btn-secondary" value="Bekor qilish" onclick="close_approve()">
            <input type="submit" class="btn btn-success" value="Tasqidlash">
        </form>
    </div>
    <div class="blank" onclick="close_approve()"></div>



    <script>

        let typed_amount = document.getElementById('product-amount')

        const sel_code = document.getElementById('sel-code-b')
        const sel_name = document.getElementById('sel-name-b')
        const sel_amount = document.getElementById('sel-amount-b')

        const products = {{ data|safe }}

        const codeSelect = document.getElementById('codeSelect');
        const nameSelect = document.getElementById('nameSelect');

        const approve = document.querySelector('.approve')
        const blank = document.querySelector('.blank')

        function open_approve(){
            if (check_amount()===1){
                approve.style.display = 'block'
                blank.style.display = 'block'

                sel_name.innerHTML = nameSelect.value;
                sel_code.innerHTML = codeSelect.value;
                sel_amount.innerHTML = typed_amount.value;

                document.getElementById('sel-name').value = sel_name.innerHTML
                document.getElementById('sel-code').value = sel_code.innerHTML
                document.getElementById('sel-amount').value = sel_amount.innerHTML
            }
            else{
                confirm("Soni yoki Kodi tanlanmagan!")
            }
        }

        function close_approve(){
            approve.style.display = 'none'
            blank.style.display = 'none'
        }


        function check_amount(){
            if(codeSelect.value === ''){
                return 0
            }
            if (typed_amount.value === ''){
                return 0
            }
            return 1
        }

        document.getElementById('tableSearch').addEventListener('keyup', function () {
            const input = this.value.toLowerCase();
            const rows = document.querySelectorAll('#productTable tbody tr');

            rows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                row.style.display = rowText.includes(input) ? '' : 'none';
            });
        })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
